<!DOCTYPE html>
<html data-controller="Ex.AppCntrl">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width">
    <title>Silica Example</title>
  </head>
  <body>
    <style>
    [data-show] {
      transition: opacity 1s;
      opacity: 1;
    }

    .hidden {
      opacity: 0 !important;
      position: absolute !important;
      z-index: -1;
      pointer-events: none;
    }
    </style>
    <div data-style="appStyle">
      <h1>{{greeting}}</h1>
      <input type="text" data-model="name" placeholder="Enter Your Name" />
      <a data-href="linkToEmail">Send Email</a>

      <form action="" data-on-submit="alertUser">
        <input type="text" data-model="name">
        <input type="email" data-model="email">
        <select data-model="selectedFont" data-repeat="font in fonts">
          <option data-model="font.key">{{font.name}}</option>
        </select>
        <input type="submit" value="Submit" data-disabled="!canSubmit">
      </form>

      <h4>{{counter}}</h4>
      <button data-on-click="increment">++</button>
      <button data-on-click="decrement">--</button>

      <ul data-repeat="user in users">
        <li>
          <h2>{{user.name}}</h2>
          <div data-repeat="grade in user.reportCard">
            <h3>{{grade.name}}</h3>
            <table data-repeat="klass in grade.classes">
              <tr>
                <td>{{klass.name}}</td>
                <td>
                  <ol data-repeat="grade in klass.grades">
                    <li data-id="Ex.indexTest(index)"
                        data-on-click="printGrade(grade, klass, user)">
                      <a data-href="grade">
                        {{grade}}
                      </a>
                    </li>
                  </ol>
                </td>
              </tr>
            </table>
          </div>
        </li>
      </ul>

      <ul data-repeat="state in states">
        <li>{{state.key}} = {{state.value}}</li>
      </ul>
      <my-element></my-element>

      <h3>Embedded Page: {{embeddedPage}}</h3>
      <div data-include="embeddedPage"></div>
      <button data-show="!runUpdates" data-on-click="startTimer">Start Timer</button>
      <button data-show="runUpdates" data-on-click="stopTimer">Stop Timer</button>
      <ul data-repeat="item in largeList" data-repeat-not-nested="true" >
        <li>{{item.value|duration}}</li>
      </ul>
    </div>
      <script src="../dist/silica.min.js" type="text/javascript" charset="utf-8"></script>
      <script type="text/javascript" charset="utf-8">
        (function(){
          'use strict';
          class ListItem {
            constructor (app) {
              this.created = new Date()
              this._app = app
            }
            get value () {
              return this._app.now - this.created
            }
          }
          window.Ex = {
            AppCntrl: class AppCntrl extends Silica.Controllers.Base {
              constructor(el) {
                super(el)
                this.name = null;
                this.characters = [];
                this.embeddedPage = "./include.html",
                this.fonts = [{key: "Arial", name:"Super A"}, {key:"Courier",
                  name:"Old Typey"}, {key:"Operator Mono", name:"Best"}];
                this.selectedFont = "Courier";
                this.states = { "FL": "Florida", "CA": "California"};
                this.largeList = [];
                this.now = new Date()
                this.counter = 0
                for (let i = 0; i < 10; i++) {
                  this.largeList.push(new ListItem(this))
                }
                this.users = [
                  {
                    name: "Alice",
                    reportCard: [
                    {
                      name: "9th",
                      classes: [
                        {
                          name: "English",
                          grades: ["A", "A", "B", "A"]
                        },
                        {
                          name: "History",
                          grades: ["B"]
                        }
                      ]
                    }
                    ]
                  },

                  {
                    name: "Bob",
                    reportCard: [
                    {
                      name: "9th",
                      classes: [
                        {
                          name: "English",
                          grades: ["C", "D"]
                        },
                        {
                          name: "History",
                          grades: ["A-"]
                        }
                      ]
                    },

                    {
                      name: "10th",
                      classes: [
                        {
                          name: "Chemistry",
                          grades: ["A+"]
                        },
                        {
                          name: "Physics",
                          grades: ["A-"]
                        }
                      ]
                    }
                    ]
                  }
                ];
              }

              linkToEmail () {
                return `mailto:${this.email}`
              }

              canSubmit() {
                return this.name && this.name.length > 0;
              }

              greeting() {
                return "Hello " + (this.name || "World!");
              }

              appStyle(){
                return `font-family: ${this.selectedFont}`
              }

              alertUser(){
                console.log(this.name, this.email);
              }

              printGrade(_, grade, klass, user) {
                console.log(user.name, "received", grade, "for", klass.name);
              }
              showFirstPage(){
                this.embeddedPage = "./include.html";
              }
              showPage2(){
                this.embeddedPage = "./include2.html";
              }

              getRandomInt (min, max) {
                min = Math.ceil(min)
                max = Math.floor(max)
                return Math.floor(Math.random() * (max - min + 1)) + min
              }

              continuouslyUpdate () {
                if (this.runUpdates) {
                  requestAnimationFrame(() => {
                    Silica.apply(() => {
                      this.now = new Date()
                      this.continuouslyUpdate()
                    })
                  })
                }
              }

              startTimer () {
                this.runUpdates = true
                this.continuouslyUpdate()
              }

              stopTimer () {
                this.runUpdates = false
              }

              increment () {
                this.counter++
              }

              decrement () {
                this.counter--
              }
            },

            indexTest(index) {
              return "Prefix-Test-" + index;
            }

          };
          Ex.AppCntrl.watchers = {
            "characters.length": function(current, previous) {
              console.log("Characters changed from", previous, "to", current);
            },
            "name": function(current, previous) {
              this.characters.push(current);
              console.log("Name changed from:", previous, "to", current);
              if (current) {
                this.email = `${current.replace(/\s/g, "_")}@gmail.com`;
              } else {
                this.email = "";
              }
            }
          };
          Ex.Router = class {
            constructor(){}
            route(loc){console.log("location is now", loc);}
          };
          var ct = class TestCntrl extends Silica.Controllers.Base {
            onClick(){Silica.goTo("/something"); }
          };
          Silica.addFilter('duration', (milis) => {
            let sec = (milis / 1000) | 0
            let min = (sec / 60) | 0
            sec = sec % 60
            let h = (min / 60) | 0
            min = min % 60
            return (h > 0 ? h + ':' : '') + `${('0'+min).substr(-2)}:${('0'+sec).substr(-2)}`
          })
          Silica.usePushState = false;
          Silica.addDirective("my-element", {
            template: "<div data-on-click='onClick'>this is my custom element</div>",
            controller: ct });
          Silica.setContext("Ex");
          Silica.setRouter(new Ex.Router);
          Silica.compile(document);
        }());
      </script>
  </body>
</html>
